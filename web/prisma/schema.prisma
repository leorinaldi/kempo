generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Media {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  type        String   // "audio" | "video"
  url         String   @db.Text
  artist      String?
  artistSlug  String?  @map("artist_slug")
  description String?  @db.Text
  aspectRatio String?  @map("aspect_ratio") // "landscape" | "portrait" | "square" (for videos)
  kyDate      DateTime? @map("ky_date") // Kempo world date (e.g., 1948-12-25 in k.y.)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  radioPlaylist RadioPlaylistItem[]
  tvPlaylist    TvPlaylistItem[]

  @@map("media")
}

model RadioPlaylistItem {
  id        String   @id @default(cuid())
  mediaId   String   @map("media_id")
  position  Int
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([mediaId])
  @@map("radio_playlist")
}

model TvPlaylistItem {
  id        String   @id @default(cuid())
  mediaId   String   @map("media_id")
  position  Int
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([mediaId])
  @@map("tv_playlist")
}

// ============ KEMPONET DOMAINS ============

model Domain {
  id           String   @id @default(cuid())
  name         String   @unique // URL slug e.g., "kempotube", "giggle"
  displayName  String?  @map("display_name") // Human-readable e.g., "KempoTube", "Giggle"
  owner        String   // e.g., "GiggleNet"
  registeredAt DateTime @map("registered_at") // real-world registration date

  pages        Page[]

  @@map("domains")
}

model Page {
  id          String   @id @default(cuid())
  domainId    String   @map("domain_id")
  domain      Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  slug        String   // path within domain: "", "about", "services/cloud"
  title       String
  content     String   @db.Text // markdown content
  excerpt     String?  @db.Text // short description for search results
  searchable  Boolean  @default(true)
  template    String?  // "default", "corporate", "product", etc.
  metadata    Json?    // flexible additional data

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([domainId, slug])
  @@index([domainId])
  @@map("pages")
}

// Search index for React app pages (search only, not used for routing)
model AppSearch {
  id          String    @id @default(cuid())
  path        String    @unique // e.g., "/kemponet/kemponet-browser"
  domain      String    // e.g., "kemponet-browser" for display in results
  title       String    // e.g., "KempoNet Browser"
  excerpt     String    @db.Text // short description for search results
  content     String    @db.Text // searchable content
  noSearch    Boolean   @default(false) @map("no_search") // exclude from search if true
  refreshedAt DateTime? @map("refreshed_at") // when AI last reviewed this page

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("app_search")
}

// ============ KEMPOPEDIA ARTICLES ============

model Article {
  id                 String     @id @default(cuid())
  slug               String     @unique
  title              String
  type               String     // "person", "place", "institution", "event", "culture", "product", "concept", "timeline", "company"
  subtype            String?    // "head-of-state", "city", etc.
  status             String     @default("published") // "published", "draft"

  // Content
  content            String     @db.Text // markdown body
  infobox            Json?      // structured infobox data
  timelineEvents     Json?      @map("timeline_events") // array of {date, headline, description}
  mediaRefs          Json?      @map("media_refs") // array of audio/video references

  // Parallel universe tracking
  parallelSwitchover Json?      @map("parallel_switchover") // {real_world, wikipedia}

  // Metadata
  tags               String[]   // PostgreSQL array
  dates              String[]   // k.y. dates mentioned in the article

  // Timestamps
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  // Relations
  revisions          Revision[]

  @@index([type])
  @@index([status])
  @@map("articles")
}

model Revision {
  id             String   @id @default(cuid())
  articleId      String   @map("article_id")
  article        Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  // Snapshot of content at this point
  title          String
  content        String   @db.Text
  infobox        Json?
  timelineEvents Json?    @map("timeline_events")

  // Real-world tracking
  createdAt      DateTime @default(now()) @map("created_at")
  editSummary    String?  @map("edit_summary")
  editorId       String?  @map("editor_id")

  // In-universe tracking
  kempoDate      String?  @map("kempo_date") // "January 15, 1950 k.y."
  kempoEvent     String?  @map("kempo_event") // "Harold Kellman inaugurated"

  @@index([articleId, createdAt])
  @@map("revisions")
}
