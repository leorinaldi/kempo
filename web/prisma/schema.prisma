generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUDIO & VIDEO MEDIA ============

model Audio {
  id          String    @id @default(cuid())
  slug        String    @unique
  name        String
  url         String    @db.Text
  type        String    @default("song")   // "song", "radio_ad", "podcast", etc.
  description String?   @db.Text
  duration    Float?                       // Duration in seconds (auto-detected at upload)
  kyDate      DateTime? @map("ky_date")    // Kempo world date (e.g., 1948-12-25 in k.y.)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  radioPlaylist RadioPlaylistItem[]
  elements      AudioElement[]

  @@map("audio")
}

model Album {
  id          String        @id @default(cuid())
  slug        String        @unique
  name        String
  artistId    String?       @map("artist_id")  // Primary artist (Person)
  artist      Person?       @relation(fields: [artistId], references: [id], onDelete: SetNull)
  labelId     String?       @map("label_id")   // Record label (Organization)
  label       Organization? @relation(fields: [labelId], references: [id], onDelete: SetNull)
  kyDate      DateTime?     @map("ky_date")    // Release date in k.y.
  articleId   String?       @unique @map("article_id")
  article     Article?      @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("albums")
}

model AudioElement {
  id        String   @id @default(cuid())
  audioId   String   @map("audio_id")
  audio     Audio    @relation(fields: [audioId], references: [id], onDelete: Cascade)
  itemId    String   @map("item_id")    // ID of the person, album, etc.
  itemType  String   @map("item_type")  // "singer", "album", "composer", "lyricist", "producer", "speaker"
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([audioId, itemId, itemType])
  @@index([itemId, itemType])
  @@map("audio_elements")
}

model Video {
  id          String    @id @default(cuid())
  slug        String    @unique
  name        String
  url         String    @db.Text
  artist      String?
  artistSlug  String?   @map("artist_slug")
  description String?   @db.Text
  duration    Float?                         // Duration in seconds (auto-detected at upload)
  width       Int?                           // Pixel width (auto-detected)
  height      Int?                           // Pixel height (auto-detected)
  aspectRatio String?   @map("aspect_ratio") // "landscape" | "portrait" | "square"
  kyDate      DateTime? @map("ky_date") // Kempo world date (e.g., 1948-12-25 in k.y.)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tvPlaylist TvPlaylistItem[]

  @@map("video")
}

model Image {
  id          String    @id @default(cuid())
  slug        String    @unique              // e.g. "clay-marshall-portrait"
  name        String                         // e.g. "Clay Marshall portrait"
  url         String    @db.Text             // Vercel Blob URL
  description String?   @db.Text             // Caption
  altText     String?   @map("alt_text")     // Accessibility text
  width       Int?                           // Pixel width (auto-detected)
  height      Int?                           // Pixel height (auto-detected)
  shape       String?                        // "portrait" | "landscape" | "square"
  category    String?                        // "portrait", "location", "product", "logo", etc.
  articleSlug String?   @map("article_slug") // Associated Kempopedia article
  kyDate      DateTime? @map("ky_date")      // When "taken" in Kempo world
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  subjects    ImageSubject[]

  @@map("image")
}

model ImageSubject {
  id        String   @id @default(cuid())
  imageId   String   @map("image_id")
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  itemId    String   @map("item_id")    // ID of the person, place, etc.
  itemType  String   @map("item_type")  // "person", "place", etc.
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([imageId, itemId, itemType])
  @@index([itemId, itemType])
  @@map("image_subjects")
}

model RadioPlaylistItem {
  id        String   @id @default(cuid())
  audioId   String   @map("audio_id")
  position  Int
  audio     Audio    @relation(fields: [audioId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([audioId])
  @@map("radio_playlist")
}

model TvPlaylistItem {
  id        String   @id @default(cuid())
  videoId   String   @map("video_id")
  position  Int
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([videoId])
  @@map("tv_playlist")
}

// ============ KEMPONET DOMAINS ============

model Domain {
  id           String   @id @default(cuid())
  name         String   @unique // URL slug e.g., "kempotube", "giggle"
  displayName  String?  @map("display_name") // Human-readable e.g., "KempoTube", "Giggle"
  owner        String   // e.g., "GiggleNet"
  registeredAt DateTime @map("registered_at") // real-world registration date

  pages        Page[]

  @@map("domains")
}

model Page {
  id          String   @id @default(cuid())
  domainId    String   @map("domain_id")
  domain      Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  slug        String   // path within domain: "", "about", "services/cloud"
  title       String
  content     String   @db.Text // markdown content
  excerpt     String?  @db.Text // short description for search results
  searchable  Boolean  @default(true)
  template    String?  // "default", "corporate", "product", etc.
  metadata    Json?    // flexible additional data

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([domainId, slug])
  @@index([domainId])
  @@map("pages")
}

// Search index for React app pages (search only, not used for routing)
model AppSearch {
  id          String    @id @default(cuid())
  path        String    @unique // e.g., "/kemponet/kemponet-browser"
  domain      String    // e.g., "kemponet-browser" for display in results
  title       String    // e.g., "KempoNet Browser"
  excerpt     String    @db.Text // short description for search results
  content     String    @db.Text // searchable content
  noSearch    Boolean   @default(false) @map("no_search") // exclude from search if true
  refreshedAt DateTime? @map("refreshed_at") // when AI last reviewed this page

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("app_search")
}

// ============ KEMPOPEDIA ARTICLES ============

model Article {
  id                 String     @id @default(cuid())
  slug               String     @unique
  title              String
  type               String     // "person", "place", "organization", "event", "culture", "product", "concept", "timeline", "company"
  subtype            String?    // "head-of-state", "city", etc.
  status             String     @default("published") // "published", "draft"

  // Content
  content            String     @db.Text // markdown body
  infobox            Json?      // structured infobox data
  timelineEvents     Json?      @map("timeline_events") // array of {date, headline, description}
  mediaRefs          Json?      @map("media_refs") // array of audio/video references

  // Parallel universe tracking
  parallelSwitchover Json?      @map("parallel_switchover") // {real_world, wikipedia}

  // Metadata
  tags               String[]   // PostgreSQL array
  dates              String[]   // k.y. dates mentioned in the article
  linkCount          Int        @default(0) @map("link_count") // count of [[wikilinks]] in content

  // Timestamps
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  // Relations
  revisions          Revision[]
  person             Person?
  organization       Organization?
  brand              Brand?
  product            Product?
  nation             Nation?
  state              State?
  city               City?
  place              Place?
  album              Album?

  @@index([type])
  @@index([status])
  @@map("articles")
}

model Revision {
  id             String   @id @default(cuid())
  articleId      String   @map("article_id")
  article        Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  // Snapshot of content at this point
  title          String
  content        String   @db.Text
  infobox        Json?
  timelineEvents Json?    @map("timeline_events")

  // Real-world tracking
  createdAt      DateTime @default(now()) @map("created_at")
  editSummary    String?  @map("edit_summary")
  editorId       String?  @map("editor_id")

  // In-universe tracking
  kempoDate      String?  @map("kempo_date") // "January 15, 1950 k.y."
  kempoEvent     String?  @map("kempo_event") // "Harold Kellman inaugurated"

  @@index([articleId, createdAt])
  @@map("revisions")
}

// ============ WORLD DATA: PEOPLE ============

model Person {
  id          String    @id @default(cuid())
  firstName   String    @map("first_name")
  middleName  String?   @map("middle_name")
  lastName    String    @map("last_name")
  nickname    String?                       // Informal name if different from firstName (e.g., "Frank" for "Francis")
  stageName   String?   @map("stage_name") // Professional/performer name (e.g., "Vivian Sterling", "Sting")
  gender      String    // "male" | "female"
  dateBorn    DateTime? @map("date_born")  // k.y. birth date
  dateDied    DateTime? @map("date_died")  // k.y. death date (null if alive)
  articleId   String?   @unique @map("article_id") // link to Kempopedia article
  article     Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  albums      Album[]   // Albums where this person is the primary artist

  @@map("people")
}

model Organization {
  id            String    @id @default(cuid())
  name          String                           // "Pacific Pictures", "National Party"
  abbreviation  String?                          // "UBC", "NAMR"
  orgType       String    @map("org_type")       // "company", "political-party", "university", etc.
  dateFounded   DateTime? @map("date_founded")   // k.y. founding date
  dateDissolved DateTime? @map("date_dissolved") // k.y. dissolution date (null if active)
  articleId     String?   @unique @map("article_id")
  article       Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  brands        Brand[]
  albums        Album[]   // Albums released by this label

  @@map("organizations")
}

model Inspiration {
  id           String   @id @default(cuid())
  subjectId    String   @map("subject_id")    // ID of person or organization
  subjectType  String   @map("subject_type")  // "person" or "organization"
  inspiration  String                         // e.g., "Frank Sinatra"
  wikipediaUrl String?  @map("wikipedia_url") // optional Wikipedia link
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([subjectId, subjectType])
  @@map("inspirations")
}

// ============ WORLD DATA: BRANDS & PRODUCTS ============

model Brand {
  id              String        @id @default(cuid())
  name            String                              // "Monarch", "Sterling", "Regal"
  organizationId  String?       @map("organization_id")
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  dateFounded     DateTime?     @map("date_founded")  // k.y. founding date
  dateDiscontinued DateTime?    @map("date_discontinued") // k.y. discontinuation date (null if active)
  articleId       String?       @unique @map("article_id")
  article         Article?      @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  products        Product[]

  @@map("brands")
}

model Product {
  id              String    @id @default(cuid())
  name            String                              // "Monarch Imperial", "Continental Courier"
  productType     String    @map("product_type")      // "vehicle", "beverage", "tobacco", "publication", etc.
  brandId         String?   @map("brand_id")
  brand           Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  dateIntroduced  DateTime? @map("date_introduced")   // k.y. launch date
  dateDiscontinued DateTime? @map("date_discontinued") // k.y. discontinuation date (null if active)
  articleId       String?   @unique @map("article_id")
  article         Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("products")
}

// ============ WORLD DATA: LOCATIONS ============

model Nation {
  id            String    @id @default(cuid())
  name          String                           // "United States", "United Kingdom"
  shortCode     String?   @map("short_code")     // "US", "UK" (for flags, abbreviations)
  dateFounded   DateTime? @map("date_founded")   // k.y. founding/independence date
  dateDissolved DateTime? @map("date_dissolved") // for historical nations (null if active)
  lat           Float?                           // latitude (center point)
  long          Float?                           // longitude (center point)
  articleId     String?   @unique @map("article_id")
  article       Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  states        State[]

  @@map("nations")
}

model State {
  id            String    @id @default(cuid())
  name          String                           // "California", "New York"
  abbreviation  String?                          // "CA", "NY"
  stateType     String    @map("state_type")     // "state", "province", "territory", "region"
  nationId      String    @map("nation_id")
  nation        Nation    @relation(fields: [nationId], references: [id], onDelete: Cascade)
  dateFounded   DateTime? @map("date_founded")   // k.y. date established/admitted
  dateDisbanded DateTime? @map("date_disbanded") // k.y. date dissolved (null if active)
  lat           Float?                           // latitude (center point)
  long          Float?                           // longitude (center point)
  articleId     String?   @unique @map("article_id")
  article       Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  cities        City[]

  @@map("states")
}

model City {
  id            String    @id @default(cuid())
  name          String                           // "Los Angeles", "Havana Springs"
  cityType      String    @map("city_type")      // "city", "town", "village"
  stateId       String    @map("state_id")
  state         State     @relation(fields: [stateId], references: [id], onDelete: Cascade)
  dateFounded   DateTime? @map("date_founded")   // k.y. founding/incorporation date
  dateDisbanded DateTime? @map("date_disbanded") // k.y. date dissolved (null if active)
  lat           Float?                           // latitude
  long          Float?                           // longitude
  articleId     String?   @unique @map("article_id")
  article       Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  places        Place[]

  @@map("cities")
}

model Place {
  id            String    @id @default(cuid())
  name          String                           // "Little Italy", "The Oasis Casino"
  placeType     String    @map("place_type")     // "neighborhood", "building", "landmark", "casino", "studio", "park", "restaurant"
  cityId        String    @map("city_id")
  city          City      @relation(fields: [cityId], references: [id], onDelete: Cascade)
  parentPlaceId String?   @map("parent_place_id") // FK to self for nesting (e.g., casino in neighborhood)
  parentPlace   Place?    @relation("PlaceHierarchy", fields: [parentPlaceId], references: [id], onDelete: SetNull)
  childPlaces   Place[]   @relation("PlaceHierarchy")
  address       String?                          // "742 Sunset Boulevard"
  dateOpened    DateTime? @map("date_opened")    // k.y. opening/establishment date
  dateClosed    DateTime? @map("date_closed")    // k.y. closure date (null if active)
  lat           Float?                           // latitude
  long          Float?                           // longitude
  articleId     String?   @unique @map("article_id")
  article       Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("places")
}

// ============ PROJECT HISTORY ============

model ProjectHistory {
  id        String   @id @default(cuid())
  content   String   @db.Text // the milestone entry text
  createdAt DateTime @default(now()) @map("created_at")

  @@map("project_history")
}

// ============ SITE SETTINGS ============

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
